# Django Model ( 模型 )

## 简介

https://codelab.website/django-models-py-split/

https://office54.net/python/django/django-model-database

模型是个类，映射到数据库中的表与字段

模型创建后需要进行数据迁移，以生成数据库中的表与字段

### 位置

也可根据需求以包的形式定义多个独立的模型模块

::: code-group

```shell [单一文件]
|- 项目目录
  |- 主应用
  |- 自定义应用
    |- __init__.py
    |- ...
    |- models.py // [!code hl]
  |- manage.py
```

```shell [定义为包]
|- 项目目录
  |- 主应用
  |- 自定义应用
    |- __init__.py
    |- ...
    |- 自定义模块包
      |- __init__.py // [!code hl]
      |- 模型模块.py // [!code hl]
      |- 模型模块.py // [!code hl]
  |- manage.py
```

```python [models/__init__.py]
from 自定义应用.自定义模块包.模型模块 import *
from 自定义应用.自定义模块包.模型模块 import 模型
```

:::

## 模型定义

模型类需要继承自`django.bd.models.Model`类

- 模型类对应数据库中的表
- 模型中的类属性对应表中字段，
- 模型的对象对应表中的一行记录

```python
from django.db import models


class 模型名(models.Model):
    类属性 = models.字段(设置=值)
```

## 字段类型

Django 会默认为数据表自动生成增长的主键列

可通过自行设置某列为主键列来不生成默认主键列

字段名不允许使用**一个以上的连续下划线**

```python
from django.db  import models
```

AutoField

## 数据迁移 （ Migrations ）

将模型自动映射到数据库的表与字段

模型结构改变后必须要进行数据迁移，以即时更新数据库中的表结构

每个自定义应用默认都有迁移文件夹`migrations`来存放迁移文件

---

### 生成迁移文件

命令执行后生成数据迁移文件，文件存放于当前应用的`migrations`目录下

若模型没有变化执行命令后会提示`No changes detected`不会生成新的迁移文件

迁移文件名为

::: code-group

```shell [命令]
python manage.py makemigrations
```

```shell [目录]
|- 项目
  |- 自定义应用
    |- migrations
      |- __init__.py
      |- ...
```

:::

::: details 例：创建模型与修改模型结构后生成迁移文件

在`django_app`项目下的`my_app`中执行

::: code-group

```python [1. 新建模型]
from django.db import models


class UserModel(models.Model):
    user_id = models.CharField(max_length=20, unique=True)

```

```shell [2. 执行命令生成迁移文件]
(.venv)  % python manage.py makemigrations
Migrations for 'my_app':
  my_app/migrations/0001_initial.py
    - Create model UserModel
```

```python [3. 迁移文件]
# Generated by Django 4.2.4 on 2023-08-22 15:08

from django.db import migrations, models


class Migration(migrations.Migration):

    initial = True

    dependencies = [
    ]

    operations = [
        migrations.CreateModel(
            name='UserModel',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('user_id', models.CharField(max_length=20, unique=True)),
            ],
        ),
    ]

```

```shell [4. 目录]
|- django_app
  |- django_app
  |- my_app
    |- __init__.py
    |- ...
    |- migrations
      |- 0001_initial.py // [!code hl]
  |- manage.py
```

:::

::: details 例：初始化的 Django 项目执行命令生成迁移文件

会提示没有变化，Django 项目默认自带 18 个 迁移文件

```shell
(.venv) % django-admin startproject django_app
(.venv) % python manage.py makemigrations // [!code hl]
No changes detected
```

:::

---

### 执行迁移

```shell
python manage.py migrate
```

将生成的迁移文件更新同步到数据库

::: details 例：创建 Django 项目后执行命令生迁移到默认数据库

Django 项目默认使用 sqlite3，详见配置文件[`settings.py`](# settings-py)

命令执行后会在项目目录下生成名为`db.sqlite3`的 Sqlite3 数据库文件

::: code-group

```shell [命令]
(.venv) % django-admin startproject django_app
(.venv) % python manage.py migrate // [!code hl]
Operations to perform:
  Apply all migrations: admin, auth, contenttypes, sessions
Running migrations:
  Applying contenttypes.0001_initial... OK
  Applying auth.0001_initial... OK
  Applying admin.0001_initial... OK
  Applying admin.0002_logentry_remove_auto_add... OK
  Applying admin.0003_logentry_add_action_flag_choices... OK
  Applying contenttypes.0002_remove_content_type_name... OK
  Applying auth.0002_alter_permission_name_max_length... OK
  Applying auth.0003_alter_user_email_max_length... OK
  Applying auth.0004_alter_user_username_opts... OK
  Applying auth.0005_alter_user_last_login_null... OK
  Applying auth.0006_require_contenttypes_0002... OK
  Applying auth.0007_alter_validators_add_error_messages... OK
  Applying auth.0008_alter_user_username_max_length... OK
  Applying auth.0009_alter_user_last_name_max_length... OK
  Applying auth.0010_alter_group_name_max_length... OK
  Applying auth.0011_update_proxy_permissions... OK
  Applying auth.0012_alter_user_first_name_max_length... OK
  Applying sessions.0001_initial... OK
```

```python [数据库配置]
DATABASE = {
    'default': {
        'ENGINE': 'django.db.backends.sqlite3',
        'NAME': BASE_DIR / 'db.sqlite3',
    }
}
```

```shell [目录]
|- 项目名
  |- 主应用
    |- __init__.py
    |- ...
  |- ...
  |- db.sqlite3 // [!code hl]
  |- manage.py
```

:::

<br/>

https://www.bilibili.com/video/BV1fh4y1Z7jp/?p=9&spm_id_from=pageDriver&vd_source=8960252a3845b76b699282b11f36ab5c

## 模型操作

https://office54.net/python/django/orm-database-operate

### 查找

模型类.objects.all()

获取该模型对应的数据表中所有数据

::: details 例：

::: code-group

```python [模型]
import django.db import models


class UserModel(models.Model):
    user_name = models.CharField(max_length=20)
```

```shell [命令]
(.venv) % python manage.py makemigrations
(.venv) % python manage.py migrate
```

```python [视图]
from django.http import HttpResponse
from my_app.models import UserModel


def users(request):

    users = UserModel.objects.all()

    print('[users]', users) # [get users] <QuerySet []>
    return HttpResponse('OK', status=200)
```

```python [路由]
from django.urls import path
from my_app.views import users


urlpatterns = [
    path('api/users/', users),
]
```

:::

---

### 过滤

---

### 增加

---

### 删除
